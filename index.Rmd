---
title: "Retirement Locator"
output: 
  flexdashboard::flex_dashboard:
    orientation: row
    #vertical_layout: scroll
    theme:
      version: 4
      bootswatch: lux
      base_font: 
        google: Castoro
      heading_font:
        google: Lato
      code_font:
        google: 
          # arguments to sass::font_google() 
          family: Roboto Mono
          local: false
      font_scale: .875
    #logo: img/logo.png
    # includes: 
    #   after_body: ./includes/footer.html
    # css: www/custom-styles.css
runtime: shiny
---


```{r global, include=F}
# url <- "https://dl.dropbox.com/s/qf0y1wmulqtduo4/2021-08-30-retirement_location.csv?dl=0"
# destfile <- paste0("./data/", "2021-08-30-retirement_location.csv")
# download.file(url = url, destfile = destfile)
retirementLoc <- readr::read_csv(file = "./data/2021-08-30-retirement_location.csv",
                                 show_col_types = FALSE)
#devtools::install_github("RobWiederstein/retirementLoc")
#data("retirementLoc", package = "retirementLoc")

```

```{r load-libraries, include=F}
library(dplyr)
library(htmltools)
library(leaflet)
library(magrittr)
library(plotly)
library(rmarkdown)
library(shiny)
library(shinyWidgets)
```
# Locator

## Sidebar {.sidebar data-width=350}

### Criteria:

```{r shiny-inputs}
tags$br()
tags$p("Twelve criteria can be selected to filter the 3000+ US counties.  (Hawaii and Alaska are excluded).  Sliders are preset at the 2.5% and 97.5% level to eliminate outliers.")
tags$br()

# Input: State ----
pickerInput("stname", "State:",
                choices = sort(unique(retirementLoc$stname)),
                selected = unique(retirementLoc$stname),
                multiple = T,
                options = list(
                `actions-box` = TRUE,
                `deselect-all-text` = "None",
                `select-all-text` = "All",
                `none-selected-text` = "zero"
                )
)
hr()
# Input: CBSA designation ----
pickerInput("cbsa_desig", "CBSA Designation:",
                choices = sort(unique(retirementLoc$cbsa_desig)),
                selected = unique(retirementLoc$cbsa_desig),
                multiple = T,
                options = list(
                `actions-box` = TRUE,
                `deselect-all-text` = "None",
                `select-all-text` = "All",
                `none-selected-text` = "zero"
                )
)
# Input: population ----
numericRangeInput(
  inputId = "pop_2020", label = "2020 Population",
  value = c(min(retirementLoc$pop_2020),
            max(retirementLoc$pop_2020))
)
# Input: Population Change Lean  ----
sliderInput("pct_pop_change", "% Pop. Change 2010 to 2020:",
         min = -35,
         max = 140,
         value = quantile(retirementLoc$pct_pop_change, 
                          probs = c(.025, .975), na.rm = T),
         step = 5,
         round = 1
)
# Input: Partisan Lean  ----
sliderInput("partisan_lean", "% Partisan Lean 2020:",
         min = 0,
         max = 90,
         value = quantile(retirementLoc$partisan_lean, 
                          probs = c(.025, .975), na.rm = T),
         step = 5,
         round = 1
)
# Input: Life Expectancy  ----
sliderInput("life_exp", "Life Expectancy (years):",
         min = round(min(retirementLoc$life_exp, na.rm = T), 0),
         max = round(max(retirementLoc$life_exp, na.rm = T), 0),
         value = quantile(retirementLoc$life_exp, 
                          probs = c(.025, 1), na.rm = T),
         step = 1,
         round = 1
)

# Input: Average annual temperature  ----
sliderInput("avg_ann_temp", "Avg. Annual Temp:",
         min = round(min(retirementLoc$avg_ann_temp, na.rm = T), 0),
         max = round(max(retirementLoc$avg_ann_temp, na.rm = T), 0),
        value = quantile(retirementLoc$avg_ann_temp, 
                          probs = c(0, 1), na.rm = T)
)
# Input: broadband 2017  ----
sliderInput("broadband_2017", "% Broadband 2017:",
         min = round(min(retirementLoc$broadband_2017, na.rm = T), 0),
         max = round(max(retirementLoc$broadband_2017, na.rm = T), 0),
         value = quantile(retirementLoc$broadband_2017, 
                          probs = c(.025, 1), na.rm = T)
)

# Input: home payoff  ----
sliderInput("years_to_payoff", "Home payoff in years:",
         min = round(min(retirementLoc$years_to_payoff, na.rm = T), 0),
         max = round(max(retirementLoc$years_to_payoff, na.rm = T), 0),
        value = quantile(retirementLoc$years_to_payoff, 
                          probs = c(0, .975), na.rm = T),
        step = .5
)
# Input: violent_crime_rate ----
sliderInput("violent_crime_rate", "Violent crime rate:",
         min = round(min(retirementLoc$violent_crime_rate, na.rm = T), 0),
         max = round(max(retirementLoc$violent_crime_rate, na.rm = T), 0),
         value = c(quantile(retirementLoc$violent_crime_rate, 
                            probs = c(0, .975), na.rm = T))
)
# Input: average daily particulate matter 2.5 microns ----
sliderInput("avg_daily_pm_2_5", "Particulate Matter 2.5:",
         min = round(min(retirementLoc$avg_daily_pm_2_5, na.rm = T), 0), 
         max = round(max(retirementLoc$avg_daily_pm_2_5, na.rm = T), 0),
         value = quantile(retirementLoc$avg_daily_pm_2_5, 
                          probs = c(0, .975), na.rm = T)
)
# Input: access to primary care physician ----
sliderInput("prim_care_dr_rate", "Primary care physicians:",
         min = round(min(retirementLoc$prim_care_dr_rate, na.rm = T), 0),
         max = round(max(retirementLoc$prim_care_dr_rate, na.rm = T), 0),
         value = quantile(retirementLoc$prim_care_dr_rate, 
                          probs = c(.025, 1), na.rm = T)
         
)

```


```{r filtered-dataset, include=F}
filtered <- reactive({
    retirementLoc %>% 
      dplyr::filter(stname %in% input$stname) %>%
      dplyr::filter(cbsa_desig %in% input$cbsa_desig) %>% 
      dplyr::filter(pop_2020 >=input$pop_2020[1] & pop_2020 <= input$pop_2020[2]) %>%
      dplyr::filter(pct_pop_change >=input$pct_pop_change[1] & pct_pop_change <= input$pct_pop_change[2]) %>% 
      dplyr::filter(partisan_lean >=input$partisan_lean[1] & partisan_lean <= input$partisan_lean[2]) %>% 
      dplyr::filter(life_exp >= input$life_exp[1] & life_exp <= input$life_exp[2]) %>% 
      dplyr::filter(avg_ann_temp >= input$avg_ann_temp[1] & avg_ann_temp <= input$avg_ann_temp[2]) %>% 
      dplyr::filter(broadband_2017 >= input$broadband_2017[1] & broadband_2017 <= input$broadband_2017[2]) %>% 
      dplyr::filter(years_to_payoff >= input$years_to_payoff[1] & years_to_payoff <= input$years_to_payoff[2]) %>% 
      dplyr::filter(violent_crime_rate >= input$violent_crime_rate[1] & violent_crime_rate <= input$violent_crime_rate[2]) %>% 
    dplyr::filter(avg_daily_pm_2_5 >= input$avg_daily_pm_2_5[1] & avg_daily_pm_2_5 <= input$avg_daily_pm_2_5[2]) %>% 
    dplyr::filter(prim_care_dr_rate >= input$prim_care_dr_rate[1] & prim_care_dr_rate <= input$prim_care_dr_rate[2])
        # filter(type %in% input$type | !complete.cases(type)) %>%
        # filter(class %in% input$class | class == "")S
  })
```
 
## Row {.tabset}

### Map

```{r render-map}
renderLeaflet({
  df <- filtered()
  pal <- colorFactor(
        palette = c('#4bbf73', '#007bff', '#e83e8c', '#fd7e14', '#f0ad4e'),
        domain = df$cbsa_desig
)
  leaflet(df) %>% 
  #addTiles() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  # setMaxBounds(lng1 = min(df$lon),
  #              lng2 = max(df$lon),
  #              lat1 = min(df$lat),
  #              lat2 = max(df$lat)
  #              ) %>% 
  setView(-98, 39.8283, zoom = 4) %>% 
  addCircleMarkers(lng = ~lon,
             lat = ~lat,
             color = ~pal(cbsa_desig),
             radius = 10,
             fillOpacity = .25,
             fill = T,
             stroke = T,
             weight = 3,
             popup = paste0("County: ", df$ctyname, "<br>",
                            "Pop 2020: ", df$pop_2020, "<br>",
                            "Growth: ", df$pct_pop_change,"%", "<br>",
                            "Part Lean: ", df$partisan_lean, "%", "<br>",
                            "Life exp: ", df$life_exp, "<br>",
                            "Avg temp: ", df$avg_ann_temp, "<br>",
                            "Broadband: ", df$broadband_2017,"%", "<br>",
                            "Payoff: ", df$years_to_payoff, " years", "<br>",
                            "Crime rate: ", df$violent_crime_rate, "<br>",
                            "PM 2.5: ", df$avg_daily_pm_2_5, "<br>",
                            "Prim. Care: ", df$prim_care_dr_rate, "<br>")
             ) %>% 
    addLegend("bottomright", pal = pal, values = df$cbsa_desig,
    title = "CBSA Designation",
    labFormat = labelFormat(prefix = "$"),
    opacity = 1
  )
})
```

### Table


```{r render-table-1}
library(DT)
DT::renderDataTable({
 df <- filtered()
 datatable(df[, 4:15],
           rownames = F,
           extensions = c('FixedColumns', 'Buttons'),
           options = list(
              fixedColumns = list(leftColumns = 2),
              pageLength = 25,
              buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
              dom = 'Bfrtip'
  )
 )
})

```

# Analyzer

## Sidebar {.sidebar data-width=350}

### Plot:

```{r}
pickerInput(
   inputId = "xaxis",
   label = "x-axis:", 
    choices = c("avg_ann_temp", "avg_daily_pm_2_5", "broadband_2017",
                "life_exp", "partisan_lean", "pct_pop_change", "pop_2020",
                "prim_care_dr_rate", "violent_crime_rate",
                "years_to_payoff"),
   selected ="pct_pop_change"
                
)
pickerInput(
   inputId = "yaxis",
   label = "y-axis:", 
    choices = c("avg_ann_temp", "avg_daily_pm_2_5", "broadband_2017",
                "life_exp", "partisan_lean", "pct_pop_change", 
                "pop_2020", "prim_care_dr_rate", "violent_crime_rate",
                "years_to_payoff"),
   selected = "years_to_payoff"
)
pickerInput(
  inputId = "groupby",
  label = "Group by:",
  choices = c("stname", "cbsa_desig"),
  selected = "stname"
)

```

## Row

### Plot

```{r plot-mydf}
renderPlotly({
  df <-filtered()
  p <- ggplot(df, aes_string(input$xaxis, 
                               input$yaxis,
                             color = input$groupby,
                             size = "pop_2020",
                             key = "ctyname"))
  p <- p + geom_point(alpha = .5)
  p <- p + geom_smooth()
  ggplotly(p, tooltip = c("key",
                          "size",
                          "color",
                          "x",
                          "y"))
})
```






